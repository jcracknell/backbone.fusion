(function(_,$){function kvp(a,b){var c={};return c[a]=b,c}function __extend(a,b){function c(){this.constructor=a}return _.each(b,function(b,c){a[c]=b}),c.prototype=b.prototype,a.prototype=new c,b.prototype}if(!$)throw"Backbone.Fusion requires jQuery";if(!_)throw"Backbone.Fusion requires underscore.js";var __module__=(__module__=typeof exports!="undefined"&&exports!==null?exports:window)&&(__module__=__module__.Backbone||function(){throw"Backbone.Fusion requires Backbone.js"}())&&(__module__=__module__.Fusion={}),ArrayCheckboxInputBinding,Binder,Binding,BindingHelpers,BooleanCheckboxInputBinding,BindingConfiguration,ElementBinding,Formats,FormattedElementBinding,TemplateBinding,TextInputBinding;__module__.Formats=Formats={integer:function(a,b){return null===a||!/^-?[0-9]+$/.test(a=a.toString())?NaN:parseInt(a,10)},"float":function(a,b){return null===a||!/^-?([0-9,]+(\.[0-9,]*)?)|(\.[0-9,]+)$/.test(a=a.toString())?NaN:parseFloat(a.replace(",",""))},money:function(a,b){return"r"==b.direction?null===a||!/^-?\$?([0-9,]+(\.[0-9]{0,2})?)|(\.[0-9]{1,2})$/.test(a=a.toString())?NaN:parseFloat(a.replace(/[^0-9.-]+/g,"")):null===a?"":(a<0?"-":"")+"$"+a.toString()},"negative-integer":function(a,b){return a=Formats.integer(a,b),a<0?a:NaN},"non-negative-integer":function(a,b){return a=Formats.integer(a,b),a>=0?a:NaN},"non-positive-integer":function(a,b){return a=Formats.integer(a,b),a<=0?a:NaN},"positive-integer":function(a,b){return a=Formats.integer(a,b),a>0?a:NaN},text:function(a){return(a||"").toString()}},__module__.BindingConfiguration=BindingConfiguration=function(){function a(a){this._defaults=a||{};if(!_.isObject(this._defaults))throw"invalid defaults"}function c(a){return"$"===a.charAt(0)}function d(a){return"@"===a.charAt(0)}function e(a){return!d(a)&&!c(a)}function f(a,d){return _.each(d,function(d,e){if(!c(e))return;var f=b[e];if(!f)throw"invalid operator: "+e.toString();a=f(d,a)}),a}function g(a,b){_.each(b,function(b,c){if(!e(c))return;if("format"===c&&_.isString(b)){var d=Formats[b];if(!d)throw'invalid named format "'+b+'"';b=d}a[c]=b})}function h(a,b){_.each(b,function(b,c){if(!d(c))return;var e=a[c]||{};e=f(e,b),g(e,b),a[c]=e})}function i(a,b){return a=f(a,b),h(a,b),g(a,b),a}var b={$reset:function(a,c){if(_.isArray(a))_.each(a,function(a){c=b.$reset(a,c)});else if(_.isString(a))delete c[a];else if(a)c={};else throw"invalid $reset param";return c}};return a.prototype.raw=function(){return this._defaults},a.prototype.merge=function(b){if(!_.isObject(b))throw"invalid other";var c={};return c=i(c,this._defaults),c=i(c,b),new a(c)},a.prototype.get=function(b){if(!_.isString(b))throw"invalid attributeName";var c={};g(c,this._defaults);var d=this._defaults["@"+b];return d&&g(c,d),new a(c)},a}(),__module__.Binding=Binding=function(){function a(){}return a.prototype.read=function(a){throw"not implemented"},a.prototype.write=function(a){throw"not implemented"},a.prototype.sources=function(a){throw"not implemented"},a}(),__module__.ElementBinding=ElementBinding=function(){function b(b,c){a.constructor.call(this);if(!_.isElement(b))throw"invalid element";if(null==c)throw"null configuration";this._element=b,this._configuration=c,this._defaultEvents=["change"]}var a=__extend(b,Binding);return b.prototype.sources=function(a){return a.target===this._element&&_.contains(this._configuration.events||this._defaultEvents,a.type)},b}(),__module__.FormattedElementBinding=FormattedElementBinding=function(){function b(b,c){a.constructor.call(this,b,c)}var a=__extend(b,ElementBinding);return b.prototype._formatValue=function(a,b,c){return this._configuration.format?this._configuration.format(a,{binding:this,configuration:this._configuration,direction:c,model:b}):a},b.prototype._readRawValue=function(){throw"not implemented"},b.prototype.read=function(a){var b=this._readRawValue();return b=this._formatValue(b,a,"r"),kvp(this._configuration.attribute,b)},b.prototype._writeRawValue=function(a){throw"not implemented"},b.prototype.write=function(a){var b=a.get(this._configuration.attribute);b=this._formatValue(b,a,"w"),this._writeRawValue(b)},b}(),__module__.TextInputBinding=TextInputBinding=function(){function b(b,c){a.constructor.call(this,b,c)}var a=__extend(b,FormattedElementBinding);return b.prototype._readRawValue=function(){return this._element.value},b.prototype._writeRawValue=function(a){this._element.value=a},b}(),__module__.BooleanCheckboxInputBinding=BooleanCheckboxInputBinding=function(){function b(b,c){a.constructor.call(this,b,c);if("checkbox"!==b.getAttribute("type"))throw"invalid element"}var a=__extend(b,ElementBinding);return b.prototype.read=function(a){return kvp(this._configuration.attribute,this._element.checked)},b.prototype.write=function(a){var b=a.get(this._configuration.attribute);this._element.checked=!!b},b}(),__module__.ArrayCheckboxInputBinding=ArrayCheckboxInputBinding=function(){function b(b,c){a.constructor.call(this,b,c);if("checkbox"!==b.getAttribute("type"))throw"invalid element"}var a=__extend(b,ElementBinding);return b.prototype.read=function(a){var b=a.get(this._configuration.attribute);return this._element.checked?kvp(this._configuration.attribute,_.union(b,[this._element.value])):kvp(this._configuration.attribute,_.without(b,this._element.value))},b.prototype.write=function(a){this._element.checked=_.contains(a.get(this._configuration.attribute),this._element.value)},b}(),__module__.TemplateBinding=TemplateBinding=function(){function b(b,c){a.constructor.call(this);if(null==b)throw"unspecified node";if(!_.isObject(c))throw"invalid defaultBindingConfigurations";this._node=b,this._template=_.template(b.nodeValue,null,{interpolate:BindingHelpers.TEMPLATE_PATTERN}),this._templateAttributes={};var d;while(d=BindingHelpers.TEMPLATE_PATTERN.exec(b.nodeValue)){var e=d[1];this._templateAttributes[e]=c["@"+e]||{}}}var a=__extend(b,Binding);return b.prototype.read=function(a){throw"unsupported operation"},b.prototype.write=function(a){var b={};_.each(this._templateAttributes,function(c,d){var e=a.get(d);c.format&&(e=c.format(e,{direction:"w",model:a,configuration:c})),b[d]=e}),this._node.nodeValue=this._template(b)},b.prototype.sources=function(a){return!1},b}(),__module__.BindingHelpers=BindingHelpers=function(){function _getDeclaredConfigurationDefaults(element){if(!element.hasAttribute(BINDING_DEFAULTS_ATTRIBUTE))return null;var declaredString=element.getAttribute(BINDING_DEFAULTS_ATTRIBUTE);return function(){try{return eval("({"+declaredString+"})")}catch(ex){throw"error evaluating "+BINDING_DEFAULTS_ATTRIBUTE+' "'+declaredString+'"'}}()}function _getDeclaredConfiguration(element){if(!element.hasAttribute(BINDING_ATTRIBUTE))return null;var attributeValue=element.getAttribute(BINDING_ATTRIBUTE);return~attributeValue.indexOf(":")?function(){try{return eval("({"+attributeValue+"})")}catch(ex){throw"error evaluating "+BINDING_ATTRIBUTE+' "'+attributeValue+'"'}}():{attribute:attributeValue}}var BINDING_ATTRIBUTE="data-binding",BINDING_DEFAULTS_ATTRIBUTE="data-binding-defaults",binders=[{bind:function(a,b){return new TextInputBinding(a,b)},binds:function(a){return"input"===a.tagName.toLowerCase()&&_.contains(["hidden","text","search","url","telephone","email","password","range","color"],a.getAttribute("type"))}},{bind:function(a,b){return new TextInputBinding(a,b)},binds:function(a){return"textarea"===a.tagName.toLowerCase()}},{bind:function(a,b){return new BooleanCheckboxInputBinding(a,b)},binds:function(a){return"input"===a.tagName.toLowerCase()&&"checkbox"===a.getAttribute("type")&&!a.hasAttribute("value")}},{bind:function(a,b){return new ArrayCheckboxInputBinding(a,b)},binds:function(a){return"input"===a.tagName.toLowerCase()&&"checkbox"===a.getAttribute("type")&&a.hasAttribute("value")}}],isTemplatedNode=function(a){return null!=a.nodeValue&&!!a.nodeValue.match(BindingHelpers.TEMPLATE_PATTERN)};return{TEMPLATE_PATTERN:/{{([a-zA-Z_$][a-zA-Z_$0-9]*)}}/g,DOM_EVENTS:["change","focus","focusin","focusout","hover","keydown","keypress","keyup","mousedown","mouseenter","mouseleave","mousemove","mouseout","mouseover","mouseup","resize","scroll","select","submit","toggle"],CreateBindingsForElement:function(a,b){if(!_.isElement(a))throw"invalid element";var c=b||new BindingConfiguration,d=_getDeclaredConfigurationDefaults(a);d&&(c=c.merge(d));var e=_getDeclaredConfiguration(a);if(e){var f=_.find(binders,function(b){return b.binds(a)});if(!f)throw"no binder binds element "+a.tagName;var g=c.get(e.attribute).merge(e);return[f.bind(a,g.raw())]}var h=[];return _.each(a.attributes,function(a){isTemplatedNode(a)&&h.push(new TemplateBinding(a,c.raw()))}),_.each(a.childNodes,function(a){switch(a.nodeType){case Node.ELEMENT_NODE:_.chain(BindingHelpers.CreateBindingsForElement(a,c)).each(function(a){h.push(a)});break;case Node.TEXT_NODE:isTemplatedNode(a)&&h.push(new TemplateBinding(a,c.raw()))}}),h}}}(),__module__.Binder=Binder=function(){function a(){this._bindings=[],this._model=null,this._element=null,this._sourceBinding=null,this._bound=!1;var a=this;this._domEventHook=function(b){return a._onDomEvent(b)}}return a.prototype._onDomEvent=function(a){if(null!=this._sourceBinding)throw"concurrent events?";this._sourceBinding=_.find(this._bindings,function(b){return b.sources(a)});if(null==this._sourceBinding)return;this._model.set(this._sourceBinding.read(this._model)),this._sourceBinding=null},a.prototype._onModelChange=function(a){_.each(this._bindings,function(a){this._sourceBinding!==a&&a.write(this._model)},this)},a.prototype.bind=function(a,b){if(null==a)throw"model must be specified";if(!_.isElement(b))throw"invalid element";if(this._bound)throw"Binder has already been bound";this._bound=!0,this._model=a,this._element=b,this._bindings=BindingHelpers.CreateBindingsForElement(b),this._model.on("change",this._onModelChange,this),$(this._element).on(BindingHelpers.DOM_EVENTS.join(" "),this._domEventHook),_.each(this._bindings,function(a){a.write(this._model)},this)},a.prototype.unbind=function(){$(this._element).off(BindingHelpers.DOM_EVENTS.join(" "),this._domEventHook),this._model.off("change",this._onModelChange,this),this._bindings=[],this._element=null,this._model=null},a}()})(_,jQuery);